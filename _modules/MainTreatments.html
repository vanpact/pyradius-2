<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MainTreatments &mdash; MasterThesis 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MasterThesis 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">MasterThesis 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for MainTreatments</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Oct 20, 2012</span>

<span class="sd">@author: yvesremi</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span>
<span class="kn">import</span> <span class="nn">PreTreatments</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="c">#import pyximport; pyximport.install() </span>

<div class="viewcode-block" id="AbstractTreatment"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AbstractTreatment">[docs]</a><span class="k">class</span> <span class="nc">AbstractTreatment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for treatments.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AbstractTreatment.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AbstractTreatment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">AbstractTreatment</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;This class is abstract and cannot be instantiated&#39;</span><span class="p">)</span> 
        <span class="nb">super</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span> <span class="o">=</span> <span class="p">[];</span>
        </div>
<div class="viewcode-block" id="AbstractTreatment.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AbstractTreatment.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        abstract method</span>
<span class="sd">        </span>
<span class="sd">        :param img: The image to process</span>
<span class="sd">        :type img: Numpy array    </span>
<span class="sd">        :raise: NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s">&quot;The method need to be implemented&quot;</span> <span class="p">)</span>
    </div></div>
<div class="viewcode-block" id="blobDetectionTreatment"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.blobDetectionTreatment">[docs]</a><span class="k">class</span> <span class="nc">blobDetectionTreatment</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class use Ellipsoid to detect the angle of the aponeurosis.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="blobDetectionTreatment.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.blobDetectionTreatment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">CV_RETR_LIST</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">CV_CHAIN_APPROX_NONE</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param mode: The mode argument in the OpenCV method findcontours</span>
<span class="sd">        :type mode: Int</span>
<span class="sd">        :param method: The method argument in the OpenCV method findcontours</span>
<span class="sd">        :type method: Int</span>
<span class="sd">        :param lines: The two extremities of the aponeurosis</span>
<span class="sd">        :type lines: Collection of QPoints      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">blobDetectionTreatment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="n">oldminx</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">oldmaxx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oldminy</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">oldmaxy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">newminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="n">oldminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminx</span><span class="p">,</span> <span class="n">oldminx</span><span class="p">)</span>
            <span class="n">newmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="n">oldmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxx</span><span class="p">,</span> <span class="n">oldmaxx</span><span class="p">)</span>
            <span class="n">newminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="n">oldminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminy</span><span class="p">,</span> <span class="n">oldminy</span><span class="p">)</span>
            <span class="n">newmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="n">oldmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxy</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitx</span> <span class="o">=</span> <span class="p">[</span><span class="n">oldminx</span><span class="p">,</span> <span class="n">oldmaxx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limity</span> <span class="o">=</span> <span class="p">[</span><span class="n">oldminy</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPoint</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())),</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPoint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limitx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">limity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">cropTreatment</span><span class="p">(([</span><span class="n">oldminx</span><span class="o">+</span><span class="mi">20</span><span class="p">,</span> <span class="n">oldminy</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="n">oldmaxx</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="o">-</span><span class="mi">10</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">GaborTreatment</span><span class="p">(</span><span class="n">ksize</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lambd</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">SobelTreatment</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernelSize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">ThresholdTreatment</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">leftpoint0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpoint1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slope0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
        <span class="n">slope1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
        <span class="n">offset0</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">leftpoint0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">oldminy</span><span class="p">)</span>
        <span class="n">offset1</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">leftpoint1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">oldminy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">oldminx</span><span class="p">,</span> <span class="n">oldmaxx</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limit0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope0</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">offset0</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">limit1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope1</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">offset1</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="blobDetectionTreatment.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.blobDetectionTreatment.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process one image in order to extract the muscle fascicle angle</span>
<span class="sd">        </span>
<span class="sd">        :param img: The image to process</span>
<span class="sd">        :type img: Numpy array    </span>
<span class="sd">        :return: The image and the extracted angle</span>
<span class="sd">        :rtype: Tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imgPre</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">!=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">angleToProcess</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pretreatments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">:</span>
            <span class="n">imgPre</span> <span class="o">=</span> <span class="n">pretreatments</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
 
        <span class="n">contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">datac</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">dataa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">datal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">center</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">fitEllipse</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">datac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">center</span>
                <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">size</span>
                <span class="n">dataa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">angle</span>
                <span class="n">datal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">fitLine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">distType</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">CV_DIST_HUBER</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aeps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
<span class="c">#                cv2.drawContours(imgToPrint, c, -1, (255, 255, 255), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c">#                cv2.line(img, (int(datal[i][2]+self.xoffset), int(datal[i][3]+self.yoffset)), (int(datal[i][2]+self.xoffset+datal[i][0]*20.0), int(datal[i][3]+self.yoffset+datal[i][1]*20.0)), cv2.cv.Scalar(255, 0, 0), 1, cv2.CV_AA, 0)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas</span><span class="p">[:])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">datasm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">datas</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">datas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">datas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">],</span> <span class="mi">0</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">checkAngle</span><span class="o">=</span><span class="bp">None</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">checkAngle</span> <span class="o">=</span> <span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dataa</span><span class="p">[:]</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="p">))</span><span class="o">&lt;=</span><span class="mf">3.0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">checkAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataa</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">checkAngle</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">toKeep</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">([(</span><span class="n">datas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">datas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="n">datas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">datas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="p">(</span><span class="n">datasm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">datasm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">checkAngle</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span><span class="c">#(datasm[0]*datasm[1])*7.0)</span>
            <span class="n">dataa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dataa</span><span class="p">[</span><span class="n">toKeep</span><span class="p">])</span>
            <span class="n">datac</span><span class="o">=</span><span class="n">datac</span><span class="p">[</span><span class="n">toKeep</span><span class="p">]</span>
            <span class="n">datas</span><span class="o">=</span><span class="n">datas</span><span class="p">[</span><span class="n">toKeep</span><span class="p">]</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">datal</span><span class="p">[</span><span class="n">toKeep</span><span class="p">]:</span>
                <span class="n">angle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>   
                
    <span class="c">#         meanY=0</span>
    <span class="c">#         meanX=0</span>
    <span class="c">#         for mag, values in zip(datas[:, 1], datal[toKeep]):</span>
    <span class="c">#             angle = numpy.arctan2(values[1], values[0])+numpy.pi/2</span>
    <span class="c">#             meanX = meanX + numpy.sin(angle)*mag</span>
    <span class="c">#             meanY = meanY + numpy.cos(angle)*mag</span>
    <span class="c">#         if(len(datas[:, 1])&gt;0):</span>
    <span class="c">#             meanY = meanY/len(datas[:, 1])</span>
    <span class="c">#             meanX = meanX/len(datas[:, 1])</span>
            
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
                <span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">%</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
                    <span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">newAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">!=</span><span class="bp">None</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newAngle</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleSin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">newAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">newAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="c">#                self.previousAngleCos = numpy.cos(2.0*self.previousAngle/5.0)*numpy.cos(3.0*newAngle/5.0)-numpy.sin(2.0*self.previousAngle/5.0)*numpy.sin(3.0*newAngle/5.0)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleCos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">newAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">newAngle</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngleSin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleCos</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newAngle</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleSin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">newAngle</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleCos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">newAngle</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngleSin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngleCos</span><span class="p">)</span>
        
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">datal</span><span class="p">[</span><span class="n">toKeep</span><span class="p">]:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">)),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">50.0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">50.0</span><span class="p">)),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_AA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c">#        for vx, vy, x0, y0 in zip((numpy.atleast_2d(datavx).T)[bestLabels==0], (numpy.atleast_2d(datavy).T)[bestLabels==0], (numpy.atleast_2d(datax).T)[bestLabels==0], (numpy.atleast_2d(datay).T)[bestLabels==0]):</span>
    <span class="c">#            cv2.line(img, (numpy.int(x0)+self.xoffset, numpy.int(y0)+self.yoffset), (numpy.int(x0)+self.xoffset+numpy.int(vx*20.), numpy.int(y0)+self.yoffset+numpy.int(vy*20.)), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
    
    <span class="c">#        for vx, vy, x0, y0 in zip(numpy.sin(dataa), -numpy.cos(dataa), (numpy.atleast_2d(datac[:, 0]).T), (numpy.atleast_2d(datac[:, 1]).T)):</span>
    <span class="c">#                        cv2.line(img, (numpy.int(x0)+self.xoffset, numpy.int(y0)+self.yoffset), (numpy.int(x0)+self.xoffset+numpy.int(vx*20.), numpy.int(y0)+self.yoffset+numpy.int(vy*20.)), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
    <span class="c">#         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(self.previousAngle))[:6], org=(numpy.uint32(img.shape[0]*0.75), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">toKeep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">toKeep</span><span class="p">[</span><span class="n">value</span><span class="p">]):</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">contours</span><span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">))</span>

        <span class="n">mx0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limitx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limitx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">my0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">mvx0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngleSin</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">mvy0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">previousAngleCos</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">mx0</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">-</span><span class="n">mvx0</span><span class="p">,</span> <span class="n">my0</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="n">mvy0</span><span class="p">),</span> <span class="p">(</span><span class="n">mx0</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="n">mvx0</span><span class="p">,</span> <span class="n">my0</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="n">mvy0</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_AA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span><span class="p">)</span><span class="c">#self.normalizeData(data)</span>
    

</div></div>
<div class="viewcode-block" id="AponeurosisTracker"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AponeurosisTracker">[docs]</a><span class="k">class</span> <span class="nc">AponeurosisTracker</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class track the position of the aponeurosis using the Lucas-Kanade algorithm and return it&#39;s orientation.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AponeurosisTracker.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AponeurosisTracker.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param line: The extremities of the aponeurosis</span>
<span class="sd">        :type mode: Collection of QPoints   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AponeurosisTracker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())),(</span><span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">cropTreatment</span><span class="p">(([</span><span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">100</span><span class="p">])))</span>
<span class="c">#        self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 15, gamma = 0.02, psi = 0))#, angleToProcess = [numpy.pi/2.0]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="c">#self.line[0][0].x()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span>  <span class="mi">0</span><span class="c">#self.sortedLines[0][1]-100#self.line[0][0].y()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">5</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">*</span><span class="n">percentage</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">5</span><span class="p">)))</span>
<span class="c">#         for percentage in numpy.arange(0.25, 0.76, 0.05):</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((self.line[0].y()+(self.line[1].y()-self.line[0].y())*percentage)-self.yoffset-9)))</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((self.line[0].y()+(self.line[1].y()-self.line[0].y())*percentage)-self.yoffset+9)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">)</span>

        
<span class="c">#        leftpoint0 = numpy.argsort(numpy.asarray([line[0][0].x(), line[0][1].x()]))[0]</span>
<span class="c">#        leftpoint1 = numpy.argsort(numpy.asarray([line[1][0].x(), line[1][1].x()]))[0]</span>
<span class="c">#        slope0 = numpy.float(line[0][1].y()-line[0][0].y())/numpy.float(line[0][1].x()-line[0][0].x())*(self.sortedLines[1][0]-self.sortedLines[0][0])</span>
<span class="c">#        slope1 = numpy.float(line[1][1].y()-line[1][0].y())/numpy.float(line[1][1].x()-line[1][0].x())*(self.sortedLines[1][0]-self.sortedLines[0][0])</span>
<span class="c">#        offset0=(line[0][leftpoint0].y()-self.sortedLines[0][1])</span>
<span class="c">#        offset1=(line[1][leftpoint1].y()-self.sortedLines[0][1])</span>
<span class="c">#        </span>
<span class="c">#        self.prevPts = []</span>
<span class="c">#        self.pts = [(self.line[0][0].x()-self.sortedLines[0][0]+10, self.line[0][0].y()-self.sortedLines[0][1]+10), (self.line[0][0].x()-self.sortedLines[0][0]+10, self.line[0][0].y()-self.sortedLines[0][1]+50), (self.line[0][1].x()-self.sortedLines[0][0]-10, self.line[0][1].y()-self.sortedLines[0][1]+50), (self.lines[0][1].x()-self.sortedLines[0][0]-10, self.lines[0][1].y()-self.sortedLines[0][1]+10)]</span>
<span class="c">#        self.mask0 = None</span>
<span class="c">#        self.mask1 = None</span>
        </div>
<div class="viewcode-block" id="AponeurosisTracker.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.AponeurosisTracker.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process one image in order to extract the aponeurosis angle</span>
<span class="sd">        </span>
<span class="sd">        :param img: The image to process</span>
<span class="sd">        :type img: Numpy array    </span>
<span class="sd">        :return: The image and the extracted angle</span>
<span class="sd">        :rtype: Tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imgPre</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortedLines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">pretreatments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">:</span>
            <span class="n">imgPre</span> <span class="o">=</span> <span class="n">pretreatments</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="n">imgPre</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">imgPreToPrint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">imgPreToPrint</span><span class="p">,</span> <span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">nextPts</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span><span class="n">prevImg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span><span class="p">,</span> <span class="n">nextImg</span> <span class="o">=</span> <span class="n">imgPre</span><span class="p">,</span> <span class="n">prevPts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">,</span> <span class="n">winSize</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">maxLevel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.00001</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">fitLine</span><span class="p">(</span><span class="n">nextPts</span><span class="p">,</span> <span class="n">distType</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">CV_DIST_HUBER</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aeps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_AA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>                   
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="n">imgPre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="n">nextPts</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
<span class="c">#        cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">nextPts</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">angle</span>

</div></div>
<div class="viewcode-block" id="MuscleTracker2"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.MuscleTracker2">[docs]</a><span class="k">class</span> <span class="nc">MuscleTracker2</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class track the muscle fascicle orientation using the Lucas-Kanade algorithm and return it&#39;s orientation.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="MuscleTracker2.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.MuscleTracker2.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fiber</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param lines: The two extremities of the aponeurosis</span>
<span class="sd">        :type lines: Collection of QPoints</span>
<span class="sd">        :param fiber: The extremities of a line parallel to the muscle fascicle</span>
<span class="sd">        :type fiber: Collection of QPoints </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuscleTracker2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="n">oldminx</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">oldmaxx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oldminy</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">oldmaxy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">newminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="n">oldminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminx</span><span class="p">,</span> <span class="n">oldminx</span><span class="p">)</span>
            <span class="n">newmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="n">oldmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxx</span><span class="p">,</span> <span class="n">oldmaxx</span><span class="p">)</span>
            <span class="n">newminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="n">oldminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminy</span><span class="p">,</span> <span class="n">oldminy</span><span class="p">)</span>
            <span class="n">newmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="n">oldmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxy</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitx</span> <span class="o">=</span> <span class="p">[</span><span class="n">oldminx</span><span class="p">,</span> <span class="n">oldmaxx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limity</span> <span class="o">=</span> <span class="p">[</span><span class="n">oldminy</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limitx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">limity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">cropTreatment</span><span class="p">(([</span><span class="n">oldminx</span><span class="p">,</span> <span class="n">oldminy</span><span class="o">-</span><span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="n">oldmaxx</span><span class="p">,</span> <span class="n">oldmaxy</span><span class="o">+</span><span class="mi">30</span><span class="p">])))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 8, gamma = 0.02, psi = 0))</span>
                                      
        <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">leftpointfiber</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">fiber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">fiber</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">distXFiber</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">leftpointfiber</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">fiber</span><span class="p">[</span><span class="n">leftpointfiber</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="n">distYFiber</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">leftpointfiber</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">fiber</span><span class="p">[</span><span class="n">leftpointfiber</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">distXFiber</span><span class="p">,</span> <span class="n">distYFiber</span><span class="p">)</span>
        <span class="n">fiberSlope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">fiber</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">fiber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">fiber</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">fiber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="c">#*(oldmaxx-oldminx)</span>
<span class="c">#         offsetFiber=(fiber[leftpointfiber].y()-oldminy)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()]))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rightpointUpper</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">1</span><span class="p">]</span>
<span class="c">#         slope0 = numpy.float(lines[self.upperAponeurosis][self.rightpointUpper].y()-lines[self.upperAponeurosis][self.leftpointUpper].y())/numpy.float(lines[self.upperAponeurosis][self.rightpointUpper].x()-lines[self.upperAponeurosis][self.leftpointUpper].x())*(oldmaxx-oldminx)</span>
        <span class="n">slope1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="c">#*(oldmaxx-oldminx)</span>
        <span class="n">offset0</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">oldminy</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">offset1</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">oldminy</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distXFiber</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">distYFiber</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">offset0</span>
        <span class="n">goodSlope</span> <span class="o">=</span> <span class="p">(</span><span class="n">slope1</span><span class="o">-</span><span class="n">fiberSlope</span><span class="p">)</span><span class="c">#/(oldmaxx-oldminx)</span>
        <span class="n">goodOffset</span><span class="o">=</span> <span class="n">offset1</span><span class="o">-</span><span class="n">offset0</span>
        <span class="n">intersectx</span> <span class="o">=</span> <span class="o">-</span><span class="n">goodOffset</span><span class="o">/</span><span class="n">goodSlope</span>
<span class="c">#         intersecty = slope1*intersectx/(oldmaxx-oldminx)+offset1</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">intersectx</span> 
        <span class="n">y1</span> <span class="o">=</span> <span class="n">slope1</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">offset1</span>
        <span class="n">fiberBegining</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
        <span class="n">fiberEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">((</span><span class="n">x1</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">((</span><span class="n">y1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">fiberEnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fiberBegining</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">fiberEnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fiberBegining</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pts0</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">15</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pts1</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowerAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rightpointLower</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">-</span><span class="mi">15</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask0</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="bp">None</span>
        </div>
<div class="viewcode-block" id="MuscleTracker2.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.MuscleTracker2.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process one image in order to extract the muscle fascicle angle</span>
<span class="sd">        </span>
<span class="sd">        :param img: The image to process</span>
<span class="sd">        :type img: Numpy array    </span>
<span class="sd">        :return: The image and the extracted angle</span>
<span class="sd">        :rtype: Tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imgPre</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> 
        <span class="k">for</span> <span class="n">pretreatments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">:</span>
            <span class="n">imgPre</span> <span class="o">=</span> <span class="n">pretreatments</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
<span class="c">#        imgPre = cv2.GaussianBlur( imgPre, (9, 9), sigmaX=1.0, sigmaY=1.0)</span>
<span class="c">#        i=0</span>
<span class="c">#        imgPreToPrint = numpy.copy(imgPre)</span>
<span class="c">#        for line in self.prevPts:</span>
<span class="c">#            i=i+1</span>
<span class="c">#            for point in line:</span>
<span class="c">#                cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask0</span><span class="p">,</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pts0</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pts1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">))</span>
        <span class="n">nextPts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">imgPreToPrint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">point</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">imgPreToPrint</span><span class="p">,</span> <span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span><span class="n">prevImg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span><span class="p">,</span> <span class="n">nextImg</span> <span class="o">=</span> <span class="n">imgPre</span><span class="p">,</span> <span class="n">prevPts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">winSize</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">maxLevel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nextPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="c">#                linefitted = cv2.fitLine(nextPts[len(nextPts)-1], distType = cv2.cv.CV_DIST_WELSCH, param = 0, reps = 1, aeps = 1)</span>
<span class="c">#                angle.append(numpy.arctan2(linefitted[1], linefitted[0])+numpy.pi/2)</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nextPts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">i</span> <span class="ow">or</span> <span class="n">nextPts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">nextPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span> <span class="o">=</span> <span class="p">[]</span>    
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>              
        <span class="k">for</span> <span class="n">prevLine</span><span class="p">,</span> <span class="n">nextLine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="p">,</span> <span class="n">nextPts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
<span class="c">#            movement = numpy.squeeze(numpy.array((prevLine, nextLine)))</span>
            <span class="k">for</span> <span class="n">prevPoint</span><span class="p">,</span> <span class="n">nextPoint</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">prevLine</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nextLine</span><span class="p">)):</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">prevPoint</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nextPoint</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">nextPoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">prevPoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">nextPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">prevPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">nextPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">prevPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">prevPoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="c">#                 cv2.circle(imgPreToPrint, (nextPoint[0], nextPoint[1]), 3, (200, 200, 200))</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<span class="c">#        for line in nextPts:</span>
<span class="c">#            for point in line:</span>
<span class="c">#                point = numpy.squeeze(point)</span>
<span class="c">#                cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (128, 128, 128))</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
            <span class="n">meanY01</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanX01</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanY11</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanX11</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanY0</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanX0</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanY1</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">meanX1</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">mag</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">meanY0</span> <span class="o">=</span> <span class="n">meanY0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanY01</span> <span class="o">=</span> <span class="n">meanY01</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanX0</span> <span class="o">=</span> <span class="n">meanX0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanX01</span> <span class="o">=</span> <span class="n">meanX01</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
            <span class="k">for</span> <span class="n">mag</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">vecAngle</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">meanY1</span> <span class="o">=</span> <span class="n">meanY1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanX1</span> <span class="o">=</span> <span class="n">meanX1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanY11</span> <span class="o">=</span> <span class="n">meanY11</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
                <span class="n">meanX11</span> <span class="o">=</span> <span class="n">meanX11</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="n">mag</span>
            <span class="n">meanY0</span> <span class="o">=</span> <span class="n">meanY0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">meanX0</span> <span class="o">=</span> <span class="n">meanX0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">meanY1</span> <span class="o">=</span> <span class="n">meanY1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">meanX1</span> <span class="o">=</span> <span class="n">meanX1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecLength</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">yVal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">meanY0</span> <span class="o">+</span> <span class="n">meanY1</span>
            <span class="n">xVal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">meanX0</span> <span class="o">+</span> <span class="n">meanX1</span>
            <span class="n">sumAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">yVal</span><span class="p">,</span> <span class="n">xVal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">xVal</span><span class="p">)</span><span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yVal</span><span class="p">))</span>
<span class="c">#        if(sumLength!=0):</span>
<span class="c">#            sumAngle = numpy.arcsin(meanLength0*numpy.sin(sumAngle)/sumLength)</span>
<span class="c">#</span>
<span class="c">#        sinSumAngle = numpy.sin(self.angle)*numpy.cos(sumAngle)+numpy.sin(sumAngle)*numpy.cos(self.angle)</span>
<span class="c">#        cosSumAngle = numpy.cos(self.angle)*numpy.cos(sumAngle)-numpy.sin(self.angle)*numpy.sin(sumAngle)</span>
<span class="c">#        sumAngle = numpy.arctan2(sinSumAngle, cosSumAngle)</span>
<span class="c">#        sumLength = numpy.sqrt(numpy.square(mx0)+ numpy.square(sumLength) + 2*mx0*sumLength*numpy.cos(sumAngle))</span>
<span class="c">#        if(sumLength!=0):</span>
<span class="c">#            sumAngle = numpy.arcsin(mx0*numpy.sin(sumAngle)/sumLength)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sumAngle</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">sumAngle</span> <span class="o">=</span> <span class="n">sumAngle</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.0</span>
            <span class="n">sumAngle</span> <span class="o">=</span> <span class="n">sumAngle</span><span class="o">%</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sumAngle</span><span class="o">&gt;=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
                <span class="n">sumAngle</span> <span class="o">=</span> <span class="n">sumAngle</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">sumAngle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevImg</span> <span class="o">=</span> <span class="n">imgPre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmpPts0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask0</span><span class="p">)</span>
        <span class="n">tmpPts1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">)</span>
        <span class="k">if</span><span class="p">((</span><span class="n">tmpPts0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmpPts1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpPts0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpPts1</span><span class="p">)</span>
<span class="c">#        i=0</span>
<span class="c">#        for line in self.prevPts:</span>
<span class="c">#            i=i+1</span>
<span class="c">#            for point in line:</span>
<span class="c">#                cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#        self.angle = numpy.median(angle)</span>
<span class="c">#        finalValueSin = numpy.sin(finalValue)*numpy.cos(self.angle)+numpy.sin(self.angle)*numpy.cos(finalValue)</span>
<span class="c">#        finalValueCos = numpy.cos(finalValue)*numpy.cos(self.angle)-numpy.sin(finalValue)*numpy.sin(self.angle)</span>
<span class="c">#        self.angle = numpy.arctan2(finalValueSin, finalValueCos)</span>
        <span class="n">mx0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="c">#(self.limitx[1]-self.limitx[0])/2</span>
        <span class="n">my0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upperAponeurosis</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">leftpointUpper</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">mvx0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="mf">5000.0</span><span class="p">)</span>
        <span class="n">mvy0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="mf">5000.0</span><span class="p">)</span>
<span class="c">#        self.angle = numpy.median(value)+self.angle</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mx0</span><span class="o">-</span><span class="n">mvx0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">my0</span><span class="o">-</span><span class="n">mvy0</span><span class="p">)),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mx0</span><span class="o">+</span><span class="n">mvx0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">my0</span><span class="o">+</span><span class="n">mvy0</span><span class="p">)),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_AA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c">#         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(self.angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span>
    
</div></div>
<div class="viewcode-block" id="testRadon"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.testRadon">[docs]</a><span class="k">class</span> <span class="nc">testRadon</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class extract the muscle fascicle orientation using the Radon transform.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="testRadon.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.testRadon.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manyCircles</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param lines: The two extremity of the aponeurosis</span>
<span class="sd">        :type lines: Collection of QPoints      </span>
<span class="sd">        :param manyCircles: if True, use 3 samples instead of one but is three times slower</span>
<span class="sd">        :type many Circles: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">testRadon</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previousAngle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">newminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span>
            <span class="n">newmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="p">)</span>
            <span class="n">newminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newminy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">)</span>
            <span class="n">newmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">newmaxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span><span class="p">)</span>
            
        <span class="n">highestLine</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lowestLine</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()]))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">leftpoint0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpoint1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slope0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span>
        <span class="n">slope1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span>
        <span class="n">offset0</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">highestLine</span><span class="p">][</span><span class="n">leftpoint0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">)</span>
        <span class="n">offset1</span><span class="o">=</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">lowestLine</span><span class="p">][</span><span class="n">leftpoint1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit0x0</span> <span class="o">=</span> <span class="n">slope0</span><span class="o">/</span><span class="mf">4.0</span><span class="o">+</span><span class="n">offset0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit0x1</span> <span class="o">=</span> <span class="n">slope0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">+</span><span class="n">offset0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit0x2</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">slope0</span><span class="o">/</span><span class="mf">4.0</span><span class="o">+</span><span class="n">offset0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit1x0</span> <span class="o">=</span> <span class="n">slope1</span><span class="o">/</span><span class="mf">4.0</span><span class="o">+</span><span class="n">offset1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit1x1</span> <span class="o">=</span> <span class="n">slope1</span><span class="o">/</span><span class="mf">2.0</span><span class="o">+</span><span class="n">offset1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit1x2</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">slope1</span><span class="o">/</span><span class="mf">4.0</span><span class="o">+</span><span class="n">offset1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circlesLimits</span> <span class="o">=</span> <span class="p">[(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x1</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">manyCircles</span><span class="o">==</span><span class="bp">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circlesLimits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x0</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circlesLimits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="mf">3.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x2</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.02</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit0x2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">limit1x2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span>
        
<span class="c">#        self.sortedLines = []</span>
<span class="c">#        for line in self.lines:</span>
<span class="c">#            self.sortedLines.append((QtCore.QPoint(min(line[0].x(), line[1].x()), min(line[0].y(), line[1].y())),QtCore.QPoint(max(line[0].x(), line[1].x()), max(line[0].y(), line[1].y()))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">cropTreatment</span><span class="p">(([</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">GaborTreatment</span><span class="p">(</span><span class="n">ksize</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lambd</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">SobelTreatment</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernelSize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">ThresholdTreatment</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span>
        </div>
<div class="viewcode-block" id="testRadon.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.testRadon.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process one image in order to extract the muscle fascicle angle</span>
<span class="sd">        </span>
<span class="sd">        :param img: The image to process</span>
<span class="sd">        :type img: Numpy array    </span>
<span class="sd">        :return: The image and the extracted angle</span>
<span class="sd">        :rtype: Tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imgPre</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">!=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">angleToProcess</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pretreatments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">:</span>
            <span class="n">imgPre</span> <span class="o">=</span> <span class="n">pretreatments</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">circleValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circlesLimits</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">imgPre</span><span class="p">)</span>
            <span class="n">centerx</span> <span class="o">=</span> <span class="n">circleValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">centery</span> <span class="o">=</span> <span class="n">circleValue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">radius</span><span class="o">=</span> <span class="n">circleValue</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">centerx</span><span class="p">,</span> <span class="n">centery</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lineType</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">imgPrefiltered</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">imgPre</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
            <span class="n">tempResult</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">dividers</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tempResult</span><span class="o">==</span><span class="bp">None</span><span class="p">):</span>
                <span class="n">dividers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">8.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dividers</span><span class="p">):</span>
                <span class="n">angleRange</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tempResult</span><span class="o">!=</span><span class="bp">None</span><span class="p">):</span>
                    <span class="n">angleRange</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tempResult</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">/</span><span class="n">i</span><span class="p">),</span> <span class="n">tempResult</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">/</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">/</span><span class="n">i</span><span class="p">)</span> 
                <span class="n">tempResult</span> <span class="o">=</span> <span class="n">angleRange</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">radon</span><span class="p">(</span><span class="n">imgPrefiltered</span><span class="p">,</span> <span class="n">angleRange</span><span class="p">),</span> <span class="mi">0</span><span class="p">))]</span>
                     
            <span class="n">angle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">tempResult</span><span class="p">))</span>
            
            <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="o">+</span><span class="n">centerx</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="o">+</span><span class="n">centery</span><span class="p">)),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lineType</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">imgPrefiltered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">imgPrefiltered</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">imgPrefiltered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">imgPrefiltered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">imgPre2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">imgPre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">imgPre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">imgPre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">),</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">img</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">imgPrefiltered</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">imgPre2</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="c">#        cv2.line(img, (self.xoffset-mvx0, self.yoffset-mvy0), (self.xoffset+mvx0, self.yoffset+mvy0), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="n">mvx0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="mf">5000.0</span><span class="p">)</span>
        <span class="n">mvy0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span><span class="o">*</span><span class="mf">5000.0</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="o">-</span><span class="n">mvx0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="o">-</span><span class="n">mvy0</span><span class="p">),</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminx</span><span class="o">+</span><span class="n">mvx0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">oldmaxy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">oldminy</span><span class="o">+</span><span class="n">mvy0</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cv</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_AA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strAngle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="o">+</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
<span class="c">#         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(strAngle))[:6], org=(numpy.uint32(img.shape[0]*0.75), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#        cv2.putText(img, &quot;angle = &quot; + numpy.str(strAngle)[:6], org=(numpy.uint32(img.shape[0]*0.75), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">strAngle</span><span class="p">)</span>
        

    </div></div>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on 25 oct 2012</span>

<span class="sd">This module has all methods to realize the junction detection on ultrasound images, by seam carving algorithm</span>

<span class="sd">@author: Van</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="seamCarving"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving">[docs]</a><span class="k">class</span> <span class="nc">seamCarving</span><span class="p">(</span><span class="n">AbstractTreatment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function use SeamCarving to extract the junction position&quot;&quot;&quot;</span>
<div class="viewcode-block" id="seamCarving.__init__"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">firstApproximation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param limits: The region of interest</span>
<span class="sd">        :type limits: Collection of QPoints</span>
<span class="sd">        :param firstApproximation: The value of initialisation of the position of the junction</span>
<span class="sd">        :type firstApproximation: QPoint</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">seamCarving</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">left</span><span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">junct</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstApproximation</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">firstApproximation</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">cropTreatment</span><span class="p">(([</span><span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">],[</span><span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PreTreatments</span><span class="o">.</span><span class="n">GaborTreatment</span><span class="p">(</span><span class="n">ksize</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lambd</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        </div>
<div class="viewcode-block" id="seamCarving.compute"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the seams carving process on the image to find the white lines and the junction point</span>
<span class="sd">        The image for this application needs to be an ultrasound image (in grey).</span>
<span class="sd">        The hiding area is the thickness of the fasciae (in pixel). </span>
<span class="sd">        </span>
<span class="sd">        :param img: matrix of the image</span>
<span class="sd">        :param a: thickness of the hiding area (below)</span>
<span class="sd">        :param b: thickness of the hiding area (above)</span>
<span class="sd">        :param hide: boolean to show or not the hiding area</span>
<span class="sd">        :param ref: boolean to show or not a reference point</span>
<span class="sd">        :return: the image with the fasciae in blue and the junction in red, the coordinates of the junction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_orig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pretreatments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtersToPreApply</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">pretreatments</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img_copy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeSeams</span><span class="p">(</span><span class="n">img_copy</span><span class="p">)</span>
        <span class="n">coord1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findSeams</span><span class="p">(</span><span class="n">img_score</span><span class="p">,</span> <span class="n">img_score</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_score</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">img_seams2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawSeamsBlack</span><span class="p">(</span><span class="n">img_copy</span><span class="p">,</span> <span class="n">coord1</span><span class="p">)</span>
        <span class="n">img_score2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeSeams</span><span class="p">(</span><span class="n">img_seams2</span><span class="p">)</span>
        <span class="n">coord2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findSeams</span><span class="p">(</span><span class="n">img_score2</span><span class="p">,</span> <span class="n">img_score2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_score2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">junct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findJunction</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">)</span>
        
        <span class="n">coord1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addOffset</span><span class="p">(</span><span class="n">coord1</span><span class="p">)</span>
        <span class="n">coord2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addOffset</span><span class="p">(</span><span class="n">coord2</span><span class="p">)</span>
        
        
        <span class="c">#Draw the 2 seams in blue</span>
        <span class="n">img_fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawSeamsBlue</span><span class="p">(</span><span class="n">img_orig</span><span class="p">,</span><span class="n">coord1</span><span class="p">)</span>
        <span class="n">img_fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawSeamsBlue</span><span class="p">(</span><span class="n">img_fin</span><span class="p">,</span> <span class="n">coord2</span><span class="p">)</span>
        
<span class="c">#         #Show the hiding thickness in black</span>
<span class="c">#         if self.hide == True :</span>
<span class="c">#             img_fin = self.drawSeamsBlack(img_fin, coord1) </span>
        <span class="n">junc_fin</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">junct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawPointRed</span><span class="p">(</span><span class="n">img_fin</span><span class="p">,</span> <span class="n">junc_fin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;JunctionX&#39;</span><span class="p">:</span><span class="n">junc_fin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;JunctionY&#39;</span><span class="p">:</span><span class="n">junc_fin</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="c">#self.drawPointRed(img_fin, junct), junct</span>
    

</div>
<div class="viewcode-block" id="seamCarving.addOffset"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.addOffset">[docs]</a>    <span class="k">def</span> <span class="nf">addOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pointList: List of the points for which the offset will be added</span>
<span class="sd">        :return: the offset list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pointList</span><span class="p">:</span>
            <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">yoffset</span><span class="p">;</span>
            <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xoffset</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">pointList</span>
            </div>
<div class="viewcode-block" id="seamCarving.makeSeams"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.makeSeams">[docs]</a>    <span class="k">def</span> <span class="nf">makeSeams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param img: Matrix of the image</span>
<span class="sd">        :return: the array of the Seams Carving Image</span>
<span class="sd">        &quot;&quot;&quot;</span>
                
        <span class="n">dimr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c">#rows</span>
        <span class="n">dimc</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c">#columns</span>
        
        <span class="c">#Image inversee completement</span>
        <span class="c">#img_rev = - img[:,-1::-1] </span>
        
<span class="c">#         img_new = numpy.ones(img.shape)</span>
        <span class="n">img_new</span> <span class="o">=</span> <span class="n">img</span>
        
        <span class="n">img_new</span><span class="p">[</span><span class="n">img_new</span><span class="p">[:,:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
         
        <span class="c">#Image avec couleur inversee</span>
        <span class="n">img_rev</span><span class="o">=</span> <span class="o">-</span><span class="n">img_new</span>
        
       
        <span class="c">#print dimr</span>
        <span class="c">#print dimc </span>
      
           
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixelScore</span><span class="p">(</span><span class="n">img_rev</span><span class="p">,</span> <span class="n">dimr</span><span class="p">,</span> <span class="n">dimc</span><span class="p">)</span>
    
    
    </div>
<div class="viewcode-block" id="seamCarving.pixelScore"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.pixelScore">[docs]</a>    <span class="k">def</span> <span class="nf">pixelScore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">dimr</span><span class="p">,</span> <span class="n">dimc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param img: matrix of the image</span>
<span class="sd">        :param dimr: dimension for rows</span>
<span class="sd">        :param dimc: dimension for columns</span>
<span class="sd">        </span>
<span class="sd">        :return: matrix of score following horizontal seam carving algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
           
        <span class="n">score</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span> 
        <span class="c">#Copy of the last column</span>
        <span class="n">score</span><span class="p">[:,</span><span class="n">dimc</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">dimc</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
        
        <span class="c">#Beginning </span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimc</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c">#If the right border is reached, only 2 values are tested. to find the minimum</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">dimr</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
                    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="nb">min</span><span class="p">([</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span> 
                <span class="c">#If the left border is reached, only 2 values are tested </span>
                <span class="k">elif</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="nb">min</span><span class="p">([</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span> 
                <span class="c">#Else, 3 values are tested</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="nb">min</span><span class="p">([</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span> 
                
                 
        <span class="c">#plt.imshow(score)</span>
        <span class="c">#plt.colorbar()</span>
        <span class="c">#plt.gca().set_ylim(0,score.shape[0])</span>
        <span class="c">#plt.show() </span>
        
        <span class="k">return</span> <span class="n">score</span> 
    
       </div>
<div class="viewcode-block" id="seamCarving.findSeams"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.findSeams">[docs]</a>    <span class="k">def</span> <span class="nf">findSeams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_score</span><span class="p">,</span> <span class="n">dimr</span><span class="p">,</span> <span class="n">dimc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param img_score: matrix of score of the image</span>
<span class="sd">        :param dimr: dimension for the rows</span>
<span class="sd">        :param dimc: dimension for the columns</span>
<span class="sd">        </span>
<span class="sd">        :return: the coordinates of the seams (way with the lowest cost) </span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">coord</span><span class="o">=</span><span class="p">[]</span>
<span class="c">#!!!        </span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">img_score</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">findSeamsHor</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_score</span><span class="p">,</span> <span class="n">dimr</span><span class="p">,</span> <span class="n">dimc</span><span class="p">)</span>
               
        <span class="k">return</span> <span class="n">coord</span>
    </div>
<div class="viewcode-block" id="seamCarving.findSeamsHor"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.findSeamsHor">[docs]</a>    <span class="k">def</span> <span class="nf">findSeamsHor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_score</span><span class="p">,</span> <span class="n">dimr</span><span class="p">,</span> <span class="n">dimc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add coordinates of the seams in a list, by finding the minimum value of the adjacent rows of the next column</span>
<span class="sd">        </span>
<span class="sd">        :param coord: list of the coordinates of the seams</span>
<span class="sd">        :param i: arguments of the row with minimum value</span>
<span class="sd">        :param img_score: matrix of the image score</span>
<span class="sd">        :param dimr: dimension of rows</span>
<span class="sd">        :param dimc: dimension of columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimc</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dimr</span><span class="o">-</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span>  <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">elif</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span>  <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">elif</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span>  <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dimr</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_score</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>    
    
    </div>
<div class="viewcode-block" id="seamCarving.drawSeamsBlue"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.drawSeamsBlue">[docs]</a>    <span class="k">def</span> <span class="nf">drawSeamsBlue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw the image with seams in blue</span>
<span class="sd">                </span>
<span class="sd">        :param img: matrix of the image</span>
<span class="sd">        :param coord: array of the coordinates [x,y] of the seams       </span>
<span class="sd">        :return: the image with the seams in blue</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord</span> <span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
            
        <span class="k">return</span> <span class="n">img</span>
        
        </div>
<div class="viewcode-block" id="seamCarving.drawSeamsBlack"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.drawSeamsBlack">[docs]</a>    <span class="k">def</span> <span class="nf">drawSeamsBlack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="c">#images jpeg a=5 et b = 40</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw the image with some thickness in black following the first seam</span>
<span class="sd">        </span>
<span class="sd">        :param img: matrix of the image</span>
<span class="sd">        :param coord: array of the coordinates [x,y] of the seams        </span>
<span class="sd">        :return: the image with the seams in black</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">minVal</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">maxVal</span><span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">junct</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">maxVal</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">junct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">junct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord</span> <span class="p">:</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">img</span><span class="p">[</span><span class="n">minVal</span><span class="p">:</span><span class="n">maxVal</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      
        <span class="k">return</span> <span class="n">img</span>
    </div>
<div class="viewcode-block" id="seamCarving.drawPointRed"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.drawPointRed">[docs]</a>    <span class="k">def</span> <span class="nf">drawPointRed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw a red little square at the position given by &quot;point&quot;</span>
<span class="sd">        </span>
<span class="sd">        :param img: matrix of the image</span>
<span class="sd">        :param point: coordinate of the point of junction       </span>
<span class="sd">        :return: the image with the red point</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">point</span> <span class="o">!=</span> <span class="p">[]</span> <span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">c</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">c</span><span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="n">img</span><span class="p">[</span><span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        
        <span class="k">return</span> <span class="n">img</span>
    
    </div>
<div class="viewcode-block" id="seamCarving.findJunction"><a class="viewcode-back" href="../MainTreatments.html#MainTreatments.seamCarving.findJunction">[docs]</a>    <span class="k">def</span> <span class="nf">findJunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param coord1: coordinates of the first fascia</span>
<span class="sd">        :param coord2: coordinates of the second fascia</span>
<span class="sd">        :return: the coordinate of the junction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">junct</span><span class="o">=</span> <span class="p">[]</span>
        
        
        <span class="c">#If fascia from above is detected first</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span> 
            <span class="n">junct</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="p">)):</span>
    
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">diff</span> <span class="p">:</span> 
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">junct</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                    
        <span class="c"># if fascia from below is detected first</span>
        <span class="k">else</span> <span class="p">:</span> 
            <span class="n">junct</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord2</span><span class="p">)):</span>
    
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">diff</span> <span class="p">:</span> 
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">junct</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coord1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>         
                      
        
        <span class="k">return</span> <span class="n">junct</span>

<span class="c"># </span>
<span class="c"># class LineFitTreatment(AbstractTreatment):</span>
<span class="c">#     def __init__(self, offset = [0, 0], mode = cv2.cv.CV_RETR_LIST, method=cv2.cv.CV_CHAIN_APPROX_NONE):</span>
<span class="c">#         self.mode = mode</span>
<span class="c">#         self.method = method</span>
<span class="c">#         self.xoffset = offset[0]</span>
<span class="c">#         self.yoffset = offset[1]</span>
<span class="c">#         self.previousAngle = 2.0</span>
<span class="c">#  </span>
<span class="c">#     def compute(self, imgPre, img):</span>
<span class="c">#         contours = cv2.findContours(imgPre.copy(), mode=self.mode, method=self.method)[0]</span>
<span class="c">#         datac = numpy.zeros((len(contours), 2), dtype=numpy.float32)</span>
<span class="c">#         datas = numpy.ones((len(contours), 2), dtype=numpy.float32)</span>
<span class="c">#         dataa = numpy.zeros((len(contours), 1), dtype=numpy.float32)</span>
<span class="c">#         i=0</span>
<span class="c"># </span>
<span class="c">#         for c in contours:</span>
<span class="c">#             if(len(c)&gt;4):</span>
<span class="c">#                 center, size, angle = cv2.fitEllipse(c)</span>
<span class="c">#                 datac[i]=center</span>
<span class="c">#                 datas[i]=size</span>
<span class="c">#                 dataa[i]=angle</span>
<span class="c"># #                cv2.ellipse(img, ((center[0]+self.xoffset, center[1]+self.yoffset), size, angle), (255, 255, 255), 1)</span>
<span class="c">#                 #cv2.line(img, (x0+self.xoffset, y0+self.yoffset), (x0+self.xoffset+vx*20., y0+self.yoffset+vy*20.), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c">#             i = i + 1</span>
<span class="c">#         datasm = numpy.median(datas, 0)</span>
<span class="c"># </span>
<span class="c">#         toKeep = numpy.all([datas[:,1]&gt;datasm[1]*5.0, datas[:, 0]&gt;0.0,(datas[:, 1]/datas[:, 0]&gt;(datasm[1]/datasm[0])*7.0)], 0)</span>
<span class="c">#         dataa = numpy.radians(dataa[toKeep])</span>
<span class="c">#         datac=datac[toKeep]</span>
<span class="c">#         datas=datas[toKeep]</span>
<span class="c"># </span>
<span class="c">#         mx0 = 0</span>
<span class="c">#         my0 = 0</span>
<span class="c">#         newAngle=numpy.float(numpy.median(dataa))</span>
<span class="c">#         if(not numpy.isnan(newAngle)):</span>
<span class="c">#             self.previousAngle = 2.0*self.previousAngle/5.0 + 3.0*newAngle/5.0</span>
<span class="c">#         mvx0 = numpy.int(numpy.sin(self.previousAngle)*5000.0)</span>
<span class="c">#         mvy0 = numpy.int(-numpy.cos(self.previousAngle)*5000.0)</span>
<span class="c">#         </span>
<span class="c"># #        for vx, vy, x0, y0 in zip((numpy.atleast_2d(datavx).T)[bestLabels==0], (numpy.atleast_2d(datavy).T)[bestLabels==0], (numpy.atleast_2d(datax).T)[bestLabels==0], (numpy.atleast_2d(datay).T)[bestLabels==0]):</span>
<span class="c"># #            cv2.line(img, (numpy.int(x0)+self.xoffset, numpy.int(y0)+self.yoffset), (numpy.int(x0)+self.xoffset+numpy.int(vx*20.), numpy.int(y0)+self.yoffset+numpy.int(vy*20.)), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c"># </span>
<span class="c"># #        for vx, vy, x0, y0 in zip(numpy.sin(dataa), -numpy.cos(dataa), (numpy.atleast_2d(datac[:, 0]).T), (numpy.atleast_2d(datac[:, 1]).T)):</span>
<span class="c"># #                        cv2.line(img, (numpy.int(x0)+self.xoffset, numpy.int(y0)+self.yoffset), (numpy.int(x0)+self.xoffset+numpy.int(vx*20.), numpy.int(y0)+self.yoffset+numpy.int(vy*20.)), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c"># #         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(self.previousAngle))[:6], org=(numpy.uint32(img.shape[0]*0.75), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#         for value in range(toKeep.shape[0]):</span>
<span class="c">#             if(toKeep[value]):</span>
<span class="c">#                 cv2.drawContours(img, contours[value], -1, (255, 255, 255), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c"># #            else:</span>
<span class="c"># #                cv2.drawContours(img, contours[value], -1, (128, 128, 128), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c">#         cv2.line(img, (mx0+self.xoffset-mvx0, my0+self.yoffset-mvy0), (mx0+self.xoffset+mvx0, my0+self.yoffset+mvy0), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c"># #        cv2.line(img, (mx1+self.xoffset, my1+self.yoffset), (mx1+self.xoffset+mvx1, my1+self.yoffset+mvy1), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c"># #        cv2.line(img, (mx2+self.xoffset, my2+self.yoffset), (mx2+self.xoffset+mvx2, my2+self.yoffset+mvy2), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c">#         return img</span>
<span class="c"># </span>
<span class="c"># class AponeurosisDetector(AbstractTreatment):</span>
<span class="c"># #   </span>
<span class="c">#     def __init__(self, mode = cv2.cv.CV_RETR_LIST, method=cv2.cv.CV_CHAIN_APPROX_NONE, lines=None):</span>
<span class="c">#         super(AponeurosisDetector, self).__init__()</span>
<span class="c">#         self.mode = mode</span>
<span class="c">#         self.method = method</span>
<span class="c">#         self.lines = lines</span>
<span class="c">#         oldminx = 100000</span>
<span class="c">#         oldmaxx = 0</span>
<span class="c">#         oldminy = 100000</span>
<span class="c">#         oldmaxy = 0</span>
<span class="c">#         for line in self.lines:</span>
<span class="c">#             newminx = min(line[0].x(), line[1].x())</span>
<span class="c">#             oldminx = min(newminx, oldminx)</span>
<span class="c">#             newmaxx = max(line[0].x(), line[1].x())</span>
<span class="c">#             oldmaxx = max(newmaxx, oldmaxx)</span>
<span class="c">#             newminy = min(line[0].y(), line[1].y())</span>
<span class="c">#             oldminy = min(newminy, oldminy)</span>
<span class="c">#             newmaxy = max(line[0].y(), line[1].y())</span>
<span class="c">#             oldmaxy = max(newmaxy, oldmaxy)</span>
<span class="c">#         self.limitx = [oldminx, oldmaxx]</span>
<span class="c">#         self.limity = [oldminy, oldmaxy]</span>
<span class="c">#         self.sortedLines = []</span>
<span class="c">#         for line in self.lines:</span>
<span class="c">#             self.sortedLines.append((QtCore.QPoint(min(line[0].x(), line[1].x()), min(line[0].y(), line[1].y())),QtCore.QPoint(max(line[0].x(), line[1].x()), max(line[0].y(), line[1].y()))))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.cropTreatment(([self.sortedLines[1][0].x(), self.sortedLines[1][0].y()-1], [self.sortedLines[1][1].x(), self.sortedLines[1][1].y()+1])))</span>
<span class="c">#         self.angle = numpy.arctan(numpy.float(self.lines[1][1].y()-self.lines[1][0].y())/numpy.float(self.lines[1][1].x()-self.lines[1][0].x())) </span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.rotateTreatment((self.angle)))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.ReduceSizeTreatment())</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 15, gamma = 0.02, psi = 0, angleToProcess = [numpy.pi/2.0]))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.SobelTreatment(dx=0, dy=1, kernelSize=7, scale=1, delta=0))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.ThresholdTreatment(-1))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.addHlineTreatment(thickness = 2, lineDistance=25))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.SkeletonTreatment())</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.ThinningTreatment())</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.erosionTreatment(size=(2, 1)))</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.DilationTreatment(size=(3, 2)))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.IncreaseSizeTreatment())</span>
<span class="c">#         self.xoffset = self.sortedLines[1][0].x()#self.lines[0][0].x()</span>
<span class="c">#         self.yoffset =  self.sortedLines[1][0].y()-1#self.lines[0][0].y()</span>
<span class="c">#         </span>
<span class="c"># #    @jit(argtypes=[uint8[:,:], uint8[:,:]], restype=uint8[:, :])    </span>
<span class="c">#     def compute(self, img):</span>
<span class="c">#         imgPre = numpy.copy(img) </span>
<span class="c">#         self.filtersToPreApply[1].setAngle(self.angle)</span>
<span class="c">#         for pretreatments in self.filtersToPreApply:</span>
<span class="c">#             imgPre = pretreatments.compute(imgPre)</span>
<span class="c">#         </span>
<span class="c">#         contours, hierarchy = cv2.findContours(imgPre.copy(), mode=self.mode, method=self.method)</span>
<span class="c">#         datac = numpy.zeros((len(contours), 2), dtype=numpy.float)</span>
<span class="c">#         datas = numpy.ones((len(contours), 2), dtype=numpy.float)</span>
<span class="c">#         dataa = numpy.zeros((len(contours), 1), dtype=numpy.float)</span>
<span class="c">#         i=0</span>
<span class="c">#         for c in contours:</span>
<span class="c">#             if(len(c)&gt;4):</span>
<span class="c">#                 center, size, angle = cv2.fitEllipse(c)</span>
<span class="c">#                 datac[i]=center</span>
<span class="c">#                 datas[i]=size</span>
<span class="c">#                 dataa[i]=angle</span>
<span class="c"># #                cv2.drawContours(img, c, -1, (200, 200, 200), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c">#                 cv2.ellipse(img, ((center[0]+self.xoffset, center[1]+self.yoffset), size, angle), (255, 255, 255), 1)</span>
<span class="c">#                 #cv2.line(img, (x0+self.xoffset, y0+self.yoffset), (x0+self.xoffset+vx*20., y0+self.yoffset+vy*20.), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)</span>
<span class="c">#             i = i + 1</span>
<span class="c">#           </span>
<span class="c"># #        goodLines = numpy.argsort((datas[:, 1]))#*datas[:, 1])/datas[:, 0])  </span>
<span class="c">#         lineSFactor = datas[:, 1]/max(datas[:, 1])</span>
<span class="c">#         lineYFactor = 1.0-numpy.abs(datac[:, 1]-(imgPre.shape[0]/2.0))/imgPre.shape[0]/2.0</span>
<span class="c">#         lineAFactor = numpy.squeeze(1.0-numpy.abs(numpy.radians(dataa-90))/numpy.max(numpy.abs(numpy.radians(dataa-90))))</span>
<span class="c">#         goodLines = numpy.argsort((numpy.add(numpy.add(lineSFactor, lineYFactor), lineAFactor)))</span>
<span class="c">#         for value in goodLines[::-1]:</span>
<span class="c"># #            if(datac[value, 1]&lt;=imgPre.shape[1]/4):</span>
<span class="c">#             largest = value</span>
<span class="c">#             cv2.drawContours(img, contours[value], -1, (200, 200, 200), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c"># #                cv2.drawContours(img, contours[value], -1, (255, 255, 255), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c">#             break</span>
<span class="c">#         dataa = numpy.radians(dataa-90)</span>
<span class="c">#         dataax = numpy.cos(dataa[largest])*numpy.cos(self.angle)-numpy.sin(self.angle)*numpy.sin(dataa[largest])</span>
<span class="c">#         dataay = numpy.sin(dataa[largest])*numpy.cos(self.angle)+numpy.sin(self.angle)*numpy.cos(dataa[largest])</span>
<span class="c">#         </span>
<span class="c">#         dataatot = numpy.arctan(dataay/dataax)</span>
<span class="c">#         x0=datac[largest, 0]</span>
<span class="c">#         y0=datac[largest, 1]</span>
<span class="c">#         x1 = numpy.uint16(-(dataax*500))</span>
<span class="c">#         y1 = numpy.uint16(-(dataay*500))</span>
<span class="c">#         x2= numpy.uint16(+(dataax*500))</span>
<span class="c">#         y2= numpy.uint16(+(dataay*500))</span>
<span class="c"># #        cv2.drawContours(img, contours, -1, (255, 255, 255))</span>
<span class="c">#         cv2.line(img, (x1+self.xoffset, y1+self.yoffset), (x2+self.xoffset, y2+self.yoffset), (255, 255, 255), 2)</span>
<span class="c"># #        cv2.ellipse(img, ((datac[largest][0]+self.xoffset,datac[largest][1]+self.yoffset), datas[largest], -dataa[largest]+90), (255, 255, 255), 2)</span>
<span class="c">#         self.angle = dataatot</span>
<span class="c">#         if(False):</span>
<span class="c">#             for value in goodLines[::-1]:</span>
<span class="c">#                 if(numpy.abs(numpy.int16(datac[value, 1])-numpy.int16(y0))&gt;imgPre.shape[1]/8):</span>
<span class="c">#                     largest = value</span>
<span class="c">#                     cv2.drawContours(img, contours[value], -1, (200, 200, 200), 2, offset=(self.xoffset, self.yoffset))</span>
<span class="c">#                     break</span>
<span class="c">#     #        largest=goodLines[len(goodLines)-2]</span>
<span class="c">#             x0=datac[largest, 0]</span>
<span class="c">#             y0=datac[largest, 1]</span>
<span class="c">#             x1 = numpy.uint16(x0-numpy.sin(dataa[largest])*1000.0)</span>
<span class="c">#             y1 = numpy.uint16(y0+numpy.cos(dataa[largest])*1000.0)</span>
<span class="c">#             x2= numpy.uint16(x0+numpy.sin(dataa[largest])*1000.0)</span>
<span class="c">#             y2= numpy.uint16(y0-numpy.cos(dataa[largest])*1000.0)</span>
<span class="c">#     #        cv2.drawContours(img, contours, -1, (255, 255, 255))</span>
<span class="c">#     #        cv2.line(img, (x1+self.xoffset, y1+self.yoffset), (x2+self.xoffset, y2+self.yoffset), (255, 255, 255), 2)</span>
<span class="c">#     #        cv2.ellipse(img, ((datac[largest][0]+self.xoffset,datac[largest][1]+self.yoffset), datas[largest], -dataa[largest]+90), (255, 255, 255), 2)</span>
<span class="c">#         return {img, self.angle}</span>
<span class="c"># </span>
<span class="c"># class AponeurosisTracker3(AbstractTreatment):</span>
<span class="c">#     </span>
<span class="c">#     def __init__(self, line=None):</span>
<span class="c">#         super(AponeurosisTracker, self).__init__()</span>
<span class="c">#         self.line = line</span>
<span class="c">#         self.prevImg = None</span>
<span class="c">#         self.sortedLines = [(min(line[0].x(), line[1].x()), min(line[0].y(), line[1].y())),(max(line[0].x(), line[1].x()), max(line[0].y(), line[1].y()))]</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.cropTreatment(([self.sortedLines[0][0], self.sortedLines[0][1]-30], [self.sortedLines[1][0], self.sortedLines[1][1]+30])))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 15, gamma = 0.02, psi = 0))#, angleToProcess = [numpy.pi/2.0]))</span>
<span class="c">#         self.xoffset = self.sortedLines[0][0]#self.line[0][0].x()</span>
<span class="c">#         self.yoffset =  self.sortedLines[0][1]-30#self.line[0][0].y()</span>
<span class="c">#         self.prevPts = []</span>
<span class="c">#         for percentage in numpy.arange(0.10, 0.92, 0.02):</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((self.line[0].y()+(self.line[1].y()-self.line[0].y())*percentage)-self.yoffset)))</span>
<span class="c">#         for percentage in numpy.arange(0.20, 0.82, 0.02):</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((self.line[0].y()+(self.line[1].y()-self.line[0].y())*percentage)-self.yoffset-10)))</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((self.line[0].y()+(self.line[1].y()-self.line[0].y())*percentage)-self.yoffset+10)))</span>
<span class="c">#         self.prevPts = numpy.asarray(self.prevPts)</span>
<span class="c"># </span>
<span class="c">#         </span>
<span class="c"># #        leftpoint0 = numpy.argsort(numpy.asarray([line[0][0].x(), line[0][1].x()]))[0]</span>
<span class="c"># #        leftpoint1 = numpy.argsort(numpy.asarray([line[1][0].x(), line[1][1].x()]))[0]</span>
<span class="c"># #        slope0 = numpy.float(line[0][1].y()-line[0][0].y())/numpy.float(line[0][1].x()-line[0][0].x())*(self.sortedLines[1][0]-self.sortedLines[0][0])</span>
<span class="c"># #        slope1 = numpy.float(line[1][1].y()-line[1][0].y())/numpy.float(line[1][1].x()-line[1][0].x())*(self.sortedLines[1][0]-self.sortedLines[0][0])</span>
<span class="c"># #        offset0=(line[0][leftpoint0].y()-self.sortedLines[0][1])</span>
<span class="c"># #        offset1=(line[1][leftpoint1].y()-self.sortedLines[0][1])</span>
<span class="c"># #        </span>
<span class="c"># #        self.prevPts = []</span>
<span class="c"># #        self.pts = [(self.line[0][0].x()-self.sortedLines[0][0]+10, self.line[0][0].y()-self.sortedLines[0][1]+10), (self.line[0][0].x()-self.sortedLines[0][0]+10, self.line[0][0].y()-self.sortedLines[0][1]+50), (self.line[0][1].x()-self.sortedLines[0][0]-10, self.line[0][1].y()-self.sortedLines[0][1]+50), (self.lines[0][1].x()-self.sortedLines[0][0]-10, self.lines[0][1].y()-self.sortedLines[0][1]+10)]</span>
<span class="c"># #        self.mask0 = None</span>
<span class="c"># #        self.mask1 = None</span>
<span class="c">#         </span>
<span class="c">#     def compute(self, img):</span>
<span class="c">#         imgPre = numpy.copy(img.astype(numpy.uint8)) </span>
<span class="c"># </span>
<span class="c">#         for pretreatments in self.filtersToPreApply:</span>
<span class="c">#             imgPre = pretreatments.compute(imgPre)</span>
<span class="c">#         if(self.prevImg == None): </span>
<span class="c">#             self.prevImg = imgPre</span>
<span class="c">#         nextPts = cv2.calcOpticalFlowPyrLK(prevImg = self.prevImg, nextImg = imgPre, prevPts = self.prevPts, winSize  = (20, 20), maxLevel = 5, criteria = (cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_COUNT, 1000, 0.0001))[0]</span>
<span class="c">#         line = cv2.fitLine(nextPts, distType = cv2.cv.CV_DIST_HUBER, param = 0, reps = 1, aeps = 1)</span>
<span class="c">#         cv2.line(img, (self.xoffset+line[2]-line[0]*1000.0,self.yoffset+line[3]-line[1]*1000.0), (self.xoffset+line[2]+line[0]*1000.0, self.yoffset+line[3]+line[1]*1000.0), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)                   </span>
<span class="c">#         del(self.prevImg)</span>
<span class="c">#         del(self.prevPts)</span>
<span class="c">#         self.prevImg = imgPre</span>
<span class="c">#         self.prevPts = nextPts</span>
<span class="c">#         minx = self.line[0].x()</span>
<span class="c">#         maxx = self.line[1].x()</span>
<span class="c">#         miny = -line[2]*line[1]+line[3]+self.yoffset</span>
<span class="c">#         maxy = ((self.sortedLines[1][0])-self.xoffset-line[2])*line[1]+self.yoffset+line[3]</span>
<span class="c">#         i=0</span>
<span class="c">#         imgPreToPrint = numpy.copy(imgPre)</span>
<span class="c">#         for point in self.prevPts:</span>
<span class="c">#             i=i+1</span>
<span class="c">#             cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#         self.prevPts = []</span>
<span class="c">#         for percentage in numpy.arange(0.10, 0.92, 0.01):</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((miny+(maxy-miny)*percentage)-self.yoffset)))</span>
<span class="c">#         for percentage in numpy.arange(0.20, 0.82, 0.02):</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((miny+(maxy-miny)*percentage)-self.yoffset-10)))</span>
<span class="c">#             self.prevPts.append((numpy.float32((self.line[0].x()+(self.line[1].x()-self.line[0].x())*percentage)-self.xoffset), numpy.float32((miny+(maxy-miny)*percentage)-self.yoffset+10)))</span>
<span class="c">#         self.prevPts = numpy.asarray(self.prevPts)</span>
<span class="c">#         i=0</span>
<span class="c">#         imgPreToPrint = numpy.copy(imgPre)</span>
<span class="c">#         for point in self.prevPts:</span>
<span class="c">#             i=i+1</span>
<span class="c">#             cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#         angle = numpy.arctan2(line[1], line[0])+numpy.pi/2</span>
<span class="c"># #        cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#         del(imgPre)</span>
<span class="c">#         del(nextPts)</span>
<span class="c">#         del(line)</span>
<span class="c">#         return (img, angle)</span>
<span class="c">#     </span>
<span class="c"># class AponeurosisTracker2(AbstractTreatment):</span>
<span class="c">#     </span>
<span class="c">#     def __init__(self, line=None):</span>
<span class="c">#         super(AponeurosisTracker, self).__init__()</span>
<span class="c">#         self.line = line</span>
<span class="c">#         self.prevImg = None</span>
<span class="c">#         self.sortedLine = [(min(line[0].x(), line[1].x()), min(line[0].y(), line[1].y())),(max(line[0].x(), line[1].x()), max(line[0].y(), line[1].y()))]</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.cropTreatment(([self.sortedLine[0][0], self.sortedLine[0][1]-30], [self.sortedLine[1][0], self.sortedLine[1][1]+30])))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 15, gamma = 0.02, psi = 0))#, angleToProcess = [numpy.pi/2.0]))</span>
<span class="c">#         self.xoffset = self.sortedLine[0][0]#self.lines[0][0].x()</span>
<span class="c">#         self.yoffset =  self.sortedLine[0][1]-30#self.lines[0][0].y()</span>
<span class="c"># #        self.prevPts = []</span>
<span class="c"># #        for percentage in numpy.arange(0.05, 1.0, 0.05):</span>
<span class="c"># #            self.prevPts.append((numpy.float32((self.lines[0].x()+(self.lines[1].x()-self.lines[0].x())*percentage)-self.xoffset), numpy.float32((self.lines[0].y()+(self.lines[1].y()-self.lines[0].y())*percentage)-self.yoffset-10)))</span>
<span class="c"># #            self.prevPts.append((numpy.float32((self.lines[0].x()+(self.lines[1].x()-self.lines[0].x())*percentage)-self.xoffset), numpy.float32((self.lines[0].y()+(self.lines[1].y()-self.lines[0].y())*percentage)-self.yoffset)))</span>
<span class="c"># #            self.prevPts.append((numpy.float32((self.lines[0].x()+(self.lines[1].x()-self.lines[0].x())*percentage)-self.xoffset), numpy.float32((self.lines[0].y()+(self.lines[1].y()-self.lines[0].y())*percentage)-self.yoffset+10)))</span>
<span class="c"># #        self.prevPts = numpy.asarray(self.prevPts)</span>
<span class="c"># </span>
<span class="c">#         self.mx0 = self.sortedLine[0][0]</span>
<span class="c">#         self.my0 = self.sortedLine[0][1]</span>
<span class="c">#         self.mvx = self.sortedLine[1][0] - self.sortedLine[0][0]</span>
<span class="c">#         self.mvy = self.sortedLine[1][1] - self.sortedLine[0][1]</span>
<span class="c">#         </span>
<span class="c">#         leftpoint0 = numpy.argsort(numpy.asarray([line[0][0].x(), line[0][1].x()]))[0]</span>
<span class="c">#         leftpoint1 = numpy.argsort(numpy.asarray([line[1][0].x(), line[1][1].x()]))[0]</span>
<span class="c">#         slope0 = numpy.float(line[0][1].y()-line[0][0].y())/numpy.float(line[0][1].x()-line[0][0].x())*(self.sortedLine[1][0]-self.sortedLine[0][0])</span>
<span class="c">#         slope1 = numpy.float(line[1][1].y()-line[1][0].y())/numpy.float(line[1][1].x()-line[1][0].x())*(self.sortedLine[1][0]-self.sortedLine[0][0])</span>
<span class="c">#         offset0=(line[0][leftpoint0].y()-self.sortedLine[0][1])</span>
<span class="c">#         offset1=(line[1][leftpoint1].y()-self.sortedLine[0][1])</span>
<span class="c">#         </span>
<span class="c">#         self.prevPts = []</span>
<span class="c">#         self.pts = [(self.line[0].x()-self.sortedLine[0][0]+10, self.line[0].y()-self.sortedLine[0][1]+10), (self.line[0].x()-self.sortedLine[0][0]+10, self.line[0].y()-self.sortedLine[0][1]+50), (self.line[1].x()-self.sortedLine[0][0]-10, self.line[1].y()-self.sortedLine[0][1]+50), (self.line[1].x()-self.sortedLine[0][0]-10, self.line[1].y()-self.sortedLine[0][1]+10)]</span>
<span class="c">#         self.mask = None</span>
<span class="c">#         </span>
<span class="c">#     def compute(self, img):</span>
<span class="c">#         imgPre = numpy.copy(img.astype(numpy.uint8)) </span>
<span class="c"># </span>
<span class="c">#         for pretreatments in self.filtersToPreApply:</span>
<span class="c">#             imgPre = pretreatments.compute(imgPre)</span>
<span class="c">#         </span>
<span class="c">#         if(self.prevImg == None): </span>
<span class="c">#             self.prevImg = numpy.copy(imgPre)</span>
<span class="c">#             self.mask0 = numpy.zeros_like(imgPre)</span>
<span class="c">#             cv2.fillPoly(self.mask, [numpy.asarray(self.pts0)], color=(255, 255, 255))</span>
<span class="c">#             self.prevPts = cv2.goodFeaturesToTrack(imgPre, 50, 0.01, 5, mask=self.mask, useHarrisDetector=True)</span>
<span class="c">#             </span>
<span class="c">#         angle = []</span>
<span class="c">#         nextPts = cv2.calcOpticalFlowPyrLK(prevImg = self.prevImg, nextImg = imgPre, prevPts = numpy.asarray(self.line, dtype=numpy.float32), winSize  = (100, 100), maxLevel = 5, criteria = (cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_COUNT, 1000, 0.0001))[0]        </span>
<span class="c"># </span>
<span class="c">#         self.vecLength = [] </span>
<span class="c">#         self.vecAngle = []</span>
<span class="c">#         for prevPoint, nextPoint in zip(numpy.squeeze(self.prevPts), numpy.squeeze(nextPts)):</span>
<span class="c">#                 self.vecLength.append(numpy.sqrt(numpy.square(nextPoint[0]-prevPoint[0])+numpy.square(nextPoint[1]-prevPoint[1])))</span>
<span class="c">#                 self.vecAngle.append(numpy.arctan2(nextPoint[1]-prevPoint[1], nextPoint[0]-prevPoint[0]))</span>
<span class="c"># #                cv2.circle(imgPreToPrint, (nextPoint[0], nextPoint[1]), 3, (200, 200, 200))</span>
<span class="c">#                 </span>
<span class="c">#         i=0</span>
<span class="c">#         for value in self.vecAngle[0]:</span>
<span class="c">#             self.vecAngle[0][i] = (value+numpy.pi/2.0)</span>
<span class="c">#             i = i+1</span>
<span class="c">#             </span>
<span class="c">#         meanY=0</span>
<span class="c">#         meanX=0</span>
<span class="c">#         for mag, angle in zip(self.vecLength[0], self.vecAngle[0]):</span>
<span class="c">#             meanX = meanX + numpy.sin(angle)*mag</span>
<span class="c">#             meanY = meanY + numpy.cos(angle)*mag</span>
<span class="c">#         meanY = meanY/len(self.vecLength[0])</span>
<span class="c">#         meanX = meanX/len(self.vecLength[0])</span>
<span class="c">#         </span>
<span class="c">#         yVal = numpy.sin(self.angle)*self.length + meanY</span>
<span class="c">#         xVal = numpy.cos(self.angle)*self.length + meanX</span>
<span class="c">#         self.mx0 = self.mx0 + meanX</span>
<span class="c">#         self.my0 = self.my0 + meanY</span>
<span class="c">#         </span>
<span class="c">#         sumAngle = numpy.arctan2(yVal, xVal)</span>
<span class="c">#         self.length = numpy.sqrt(numpy.square(xVal)+ numpy.square(yVal))</span>
<span class="c">#         </span>
<span class="c">#         if(sumAngle&lt;0):</span>
<span class="c">#             sumAngle = sumAngle+numpy.pi*2.0</span>
<span class="c">#         sumAngle = sumAngle%(numpy.pi*2.0)</span>
<span class="c">#         if(sumAngle&gt;=numpy.pi):</span>
<span class="c">#             sumAngle = sumAngle-numpy.pi</span>
<span class="c">#         self.prevImg = imgPre</span>
<span class="c">#         self.prevPts = []</span>
<span class="c">#         self.prevPts.append(cv2.goodFeaturesToTrack(imgPre, 50, 0.01, 5, mask=self.mask0, useHarrisDetector=True))</span>
<span class="c">#         self.angle = sumAngle</span>
<span class="c">#         </span>
<span class="c">#         mx0=(self.line[0]-self.limitx[0])/2</span>
<span class="c">#         my0=(self.limity[1]-self.limity[0])/2</span>
<span class="c">#         mvx0 = numpy.int(numpy.sin(self.angle)*5000.0)</span>
<span class="c">#         mvy0 = numpy.int(-numpy.cos(self.angle)*5000.0)</span>
<span class="c"># #        self.angle = numpy.median(value)+self.angle</span>
<span class="c">#         cv2.line(img, (int(mx0+self.xoffset-mvx0), int(my0+self.yoffset-mvy0)), (int(mx0+self.xoffset+mvx0), int(my0+self.yoffset+mvy0)), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c"># #         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(self.angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#         return (img, self.angle)</span>
<span class="c">#     </span>
<span class="c">#         line = cv2.fitLine(nextPts, distType = cv2.cv.CV_DIST_HUBER, param = 0, reps = 1, aeps = 1)</span>
<span class="c">#         cv2.line(img, (self.xoffset+line[2]-line[0]*1000.0,self.yoffset+line[3]-line[1]*1000.0), (self.xoffset+line[2]+line[0]*1000.0, self.yoffset+line[3]+line[1]*1000.0), cv2.cv.Scalar(255, 0, 0), 3, cv2.CV_AA, 0)                   </span>
<span class="c">#         del(self.prevPyramid)</span>
<span class="c">#         del(self.prevImg)</span>
<span class="c">#         del(self.prevPts)</span>
<span class="c"># </span>
<span class="c">#         self.prevImg = imgPre</span>
<span class="c">#         self.prevPts = nextPts</span>
<span class="c">#         i=0</span>
<span class="c">#         imgPreToPrint = numpy.copy(imgPre)</span>
<span class="c">#         for point in self.prevPts:</span>
<span class="c">#             i=i+1</span>
<span class="c">#             cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#         angle = numpy.arctan2(line[1], line[0])+numpy.pi/2</span>
<span class="c"># #        cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#         del(imgPre)</span>
<span class="c"># </span>
<span class="c">#         del(nextPts)</span>
<span class="c">#         del(line)</span>
<span class="c">#         return (img, angle)</span>
<span class="c"># </span>
<span class="c"># class MuscleTracker(AbstractTreatment):</span>
<span class="c">#     </span>
<span class="c">#     def __init__(self, lines=None, fiber=None):</span>
<span class="c">#         super(MuscleTracker, self).__init__()</span>
<span class="c">#         self.previousAngle = None</span>
<span class="c">#         self.lines = lines</span>
<span class="c">#         oldminx = 100000</span>
<span class="c">#         oldmaxx = 0</span>
<span class="c">#         oldminy = 100000</span>
<span class="c">#         oldmaxy = 0</span>
<span class="c">#         for line in self.lines:</span>
<span class="c">#             newminx = min(line[0].x(), line[1].x())</span>
<span class="c">#             oldminx = min(newminx, oldminx)</span>
<span class="c">#             newmaxx = max(line[0].x(), line[1].x())</span>
<span class="c">#             oldmaxx = max(newmaxx, oldmaxx)</span>
<span class="c">#             newminy = min(line[0].y(), line[1].y())</span>
<span class="c">#             oldminy = min(newminy, oldminy)</span>
<span class="c">#             newmaxy = max(line[0].y(), line[1].y())</span>
<span class="c">#             oldmaxy = max(newmaxy, oldmaxy)</span>
<span class="c">#         self.limitx = [oldminx, oldmaxx]</span>
<span class="c">#         self.limity = [oldminy, oldmaxy]</span>
<span class="c">#         self.sortedLines = []</span>
<span class="c">#         for line in self.lines:</span>
<span class="c">#             self.sortedLines.append((QtCore.QPoint(min(line[0].x(), line[1].x()), min(line[0].y(), line[1].y())),QtCore.QPoint(max(line[0].x(), line[1].x()), max(line[0].y(), line[1].y()))))</span>
<span class="c">#         self.xoffset = self.limitx[0]</span>
<span class="c">#         self.yoffset =  self.limity[0]</span>
<span class="c">#         self.filtersToPreApply.append(PreTreatments.cropTreatment(([oldminx, oldminy], [oldmaxx, oldmaxy])))</span>
<span class="c"># #        self.filtersToPreApply.append(PreTreatments.GaborTreatment(ksize = 31, sigma = 1.5, lambd = 15, gamma = 0.02, psi = 0))</span>
<span class="c">#                                       </span>
<span class="c">#         self.fiber = fiber</span>
<span class="c">#         self.prevImg = None</span>
<span class="c">#         leftpointfiber = numpy.argsort(numpy.asarray([fiber[0].x(), fiber[1].x()]))[0]</span>
<span class="c">#         distXFiber = fiber[1-leftpointfiber].x()-fiber[leftpointfiber].x()</span>
<span class="c">#         distYFiber = fiber[1-leftpointfiber].y()-fiber[leftpointfiber].y()</span>
<span class="c">#         self.angle = numpy.pi-numpy.arctan2(distXFiber, distYFiber)</span>
<span class="c">#         fiberSlope = numpy.float(fiber[1].y()-fiber[0].y())/numpy.float(fiber[1].x()-fiber[0].x())*(oldmaxx-oldminx)</span>
<span class="c">#         offsetFiber=(fiber[leftpointfiber].y()-oldminy)</span>
<span class="c">#         </span>
<span class="c">#         leftpoint0 = numpy.argsort(numpy.asarray([lines[0][0].x(), lines[0][1].x()]))[0]</span>
<span class="c">#         leftpoint1 = numpy.argsort(numpy.asarray([lines[1][0].x(), lines[1][1].x()]))[0]</span>
<span class="c">#         slope0 = numpy.float(lines[0][1].y()-lines[0][0].y())/numpy.float(lines[0][1].x()-lines[0][0].x())*(oldmaxx-oldminx)</span>
<span class="c">#         slope1 = numpy.float(lines[1][1].y()-lines[1][0].y())/numpy.float(lines[1][1].x()-lines[1][0].x())*(oldmaxx-oldminx)</span>
<span class="c">#         self.offset0=(lines[0][leftpoint0].y()-oldminy)</span>
<span class="c">#         self.offset1=(lines[1][leftpoint1].y()-oldminy)</span>
<span class="c">#         </span>
<span class="c">#         self.prevPts = []</span>
<span class="c">#         for percentagex in numpy.arange(-1.00, 1.1, 0.2):</span>
<span class="c">#             x0 = (oldmaxx-oldminx)*percentagex</span>
<span class="c">#             y0 = slope0*percentagex+self.offset0</span>
<span class="c">#             goodSlope = (slope1-fiberSlope)/(oldmaxx-oldminx)</span>
<span class="c">#             goodOffset= self.offset1-self.offset0</span>
<span class="c">#             intersectx = -goodOffset/goodSlope + (oldmaxx-oldminx)*percentagex</span>
<span class="c">#             intersecty = slope1*intersectx/(oldmaxx-oldminx)+self.offset1</span>
<span class="c">#             x1 = intersectx </span>
<span class="c">#             y1 = slope1*x1/(oldmaxx-oldminx)+self.offset1</span>
<span class="c"># #            y1 = slope1*percentagex+offset1</span>
<span class="c">#             x = numpy.uint((percentagex+1.000001)*5.0)</span>
<span class="c">#             self.prevPts.append([])</span>
<span class="c">#             for percentagey in numpy.arange(0.20, 1.0, 0.20):</span>
<span class="c">#                 xToAdd = numpy.int((x0+(x1-x0)*percentagey))</span>
<span class="c">#                 yToAdd = numpy.int((y0+(y1-y0)*percentagey))</span>
<span class="c">#                 if(xToAdd&lt;(oldmaxx-oldminx)-20 and yToAdd&lt;(oldmaxy-oldminy)-20 and xToAdd&gt;=20 and yToAdd&gt;=20):</span>
<span class="c">#                     self.prevPts[x].append((xToAdd, yToAdd))</span>
<span class="c">#         self.prevPts = numpy.asarray(self.prevPts)</span>
<span class="c"># </span>
<span class="c">#         self.prevImg = None</span>
<span class="c">#         </span>
<span class="c">#     def compute(self, img):</span>
<span class="c">#         imgPre = numpy.copy(img.astype(numpy.uint8)) </span>
<span class="c"># </span>
<span class="c">#         for pretreatments in self.filtersToPreApply:</span>
<span class="c">#             imgPre = pretreatments.compute(imgPre)</span>
<span class="c"># #        imgPre = cv2.GaussianBlur( imgPre, (9, 9), sigmaX=1.0, sigmaY=1.0)</span>
<span class="c"># #        i=0</span>
<span class="c"># #        imgPreToPrint = numpy.copy(imgPre)</span>
<span class="c"># #        for line in self.prevPts:</span>
<span class="c"># #            i=i+1</span>
<span class="c"># #            for point in line:</span>
<span class="c"># #                cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#         if(self.prevImg == None): </span>
<span class="c">#             self.prevImg = numpy.copy(imgPre)</span>
<span class="c">#             self.prevPyramid = cv2.buildOpticalFlowPyramid(img = imgPre, winSize = (21, 21), maxLevel = 3)[1]</span>
<span class="c">#         pyramid = cv2.buildOpticalFlowPyramid(imgPre, (21, 21), 3)[1]</span>
<span class="c">#         nextPts = []</span>
<span class="c">#         angle = []</span>
<span class="c">#         for line in self.prevPts:</span>
<span class="c">#             if(numpy.asarray(line).shape[0]&gt;1):</span>
<span class="c">#                 nextPts.append(cv2.calcOpticalFlowPyrLK(prevImg = self.prevImg, nextImg = imgPre, prevPts = numpy.asarray(line, dtype=numpy.float32), winSize  = (100, 100), maxLevel = 5, criteria = (cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_COUNT, 1000, 0.0001))[0])</span>
<span class="c">#                 linefitted = cv2.fitLine(nextPts[len(nextPts)-1], distType = cv2.cv.CV_DIST_L2, param = 0, reps = 1, aeps = 1)</span>
<span class="c">#                 angle.append(numpy.arctan2(linefitted[1], linefitted[0])+numpy.pi/2)                   </span>
<span class="c">#         self.prevPyramid = pyramid</span>
<span class="c">#         self.prevImg = imgPre</span>
<span class="c">#         self.prevPts = numpy.asarray(nextPts)</span>
<span class="c"># #        i=0</span>
<span class="c"># #        for line in self.prevPts:</span>
<span class="c"># #            i=i+1</span>
<span class="c"># #            for point in line:</span>
<span class="c"># #                cv2.circle(imgPreToPrint, (point[0], point[1]), 3, (255, 255, 255))</span>
<span class="c">#         i=0</span>
<span class="c">#         for value in angle:</span>
<span class="c">#             angle[i] = value%(numpy.pi*2.0)</span>
<span class="c">#             if(angle[i]&gt;=numpy.pi):</span>
<span class="c">#                 angle[i] = value-numpy.pi</span>
<span class="c">#             i = i+1</span>
<span class="c">#         self.angle = numpy.median(angle)</span>
<span class="c"># #        finalValueSin = numpy.sin(finalValue)*numpy.cos(self.angle)+numpy.sin(self.angle)*numpy.cos(finalValue)</span>
<span class="c"># #        finalValueCos = numpy.cos(finalValue)*numpy.cos(self.angle)-numpy.sin(finalValue)*numpy.sin(self.angle)</span>
<span class="c"># #        self.angle = numpy.arctan2(finalValueSin, finalValueCos)</span>
<span class="c">#         mx0=0#(self.limitx[1]-self.limitx[0])/2</span>
<span class="c">#         my0=self.offset0#(self.limity[1]-self.limity[0])/2</span>
<span class="c">#         mvx0 = numpy.int(numpy.sin(self.angle)*5000.0)</span>
<span class="c">#         mvy0 = numpy.int(-numpy.cos(self.angle)*5000.0)</span>
<span class="c"># #        self.angle = numpy.median(value)+self.angle</span>
<span class="c">#         cv2.line(img, (mx0+self.xoffset-mvx0, my0+self.yoffset-mvy0), (mx0+self.xoffset+mvx0, my0+self.yoffset+mvy0), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c"># #         cv2.putText(img, &quot;angle = &quot; + numpy.str(numpy.degrees(self.angle))[:6], org=(numpy.uint32(img.shape[0]*0.0), numpy.uint32(img.shape[1]*0.75)), fontFace=cv2.FONT_HERSHEY_SIMPLEX, fontScale=0.8, color=(255, 255, 255), thickness=2, bottomLeftOrigin=False)</span>
<span class="c">#         return img, self.angle</span>
<span class="c">#     </span>
<span class="c"># class aponeurosisHough(AbstractTreatment):</span>
<span class="c">#     </span>
<span class="c">#     def __init__(self, offset=[0, 0], angle=0):</span>
<span class="c">#         self.xoffset = offset[0]</span>
<span class="c">#         self.yoffset = offset[1]</span>
<span class="c">#         self.angle = angle</span>
<span class="c">#         </span>
<span class="c">#         </span>
<span class="c">#     def compute(self, imgPre, img):</span>
<span class="c"># </span>
<span class="c">#         center = (imgPre.shape[0]/2.0, imgPre.shape[1]/2.0)</span>
<span class="c">#         M = cv2.getRotationMatrix2D(center, numpy.degrees(self.angle), 1.0)</span>
<span class="c">#         alpha = numpy.cos(-self.angle)</span>
<span class="c">#         beta = numpy.sin(-self.angle)</span>
<span class="c">#         sizemaxX = numpy.int(alpha*imgPre.shape[1])#-beta*img.shape[0])</span>
<span class="c">#         sizemaxY = numpy.int(beta*imgPre.shape[1]+alpha*imgPre.shape[0])</span>
<span class="c">#         imgPre = cv2.warpAffine(imgPre, M, (sizemaxX, sizemaxY))[sizemaxY/2-30:sizemaxY/2+30, 0:sizemaxX]</span>
<span class="c">#         </span>
<span class="c">#         lines = cv2.HoughLinesP(image = numpy.copy(numpy.uint8(imgPre)), rho=15, theta=numpy.float(cv2.cv.CV_PI)/180.0, threshold = 2, minLineLength = 100, maxLineGap = 7)</span>
<span class="c">#         lines = numpy.squeeze(lines)</span>
<span class="c">#         if(len(lines.shape)&gt;1):</span>
<span class="c">#             angle = numpy.zeros(lines.shape[0], dtype=numpy.float32)</span>
<span class="c">#             leng = numpy.zeros(lines.shape[0], dtype=numpy.float32)</span>
<span class="c">#             i=0</span>
<span class="c">#             for line in lines:</span>
<span class="c">#                 leng[i] = numpy.sqrt(numpy.power(line[3]-line[1], 2)+numpy.power(line[2]-line[0], 2))</span>
<span class="c">#                 if(line[2]-line[0]!=0):</span>
<span class="c">#                     angle[i] = numpy.arctan(numpy.float(line[3]-line[1])/numpy.float(line[2]-line[0]))</span>
<span class="c">#                 elif(line[3]-line[1]&gt;0):</span>
<span class="c">#                     angle[i]=cv2.cv.CV_PI/2.0</span>
<span class="c">#                 else:</span>
<span class="c">#                     angle[i]=-cv2.cv.CV_PI/2.0</span>
<span class="c">#                 i=i+1</span>
<span class="c">#             sortedIndex = numpy.argsort(leng)</span>
<span class="c">#             n = numpy.ceil(sortedIndex.shape[0]/5.0)</span>
<span class="c">#             n = min(sortedIndex.shape[0], 3)</span>
<span class="c">#             valueNumber = sortedIndex.shape[0]-n</span>
<span class="c">#             accumAngleX = 0</span>
<span class="c">#             accumAngleY = 0</span>
<span class="c">#             for values in sortedIndex[valueNumber:]:</span>
<span class="c">#                 accumAngleX = accumAngleX+numpy.cos(angle[values])</span>
<span class="c">#                 accumAngleY = accumAngleY+numpy.sin(angle[values])</span>
<span class="c"># #                accumx1 = accumx1+lines[values, 0]</span>
<span class="c"># #                accumy1 = accumy1+lines[values, 1]</span>
<span class="c"># #                accumx2 = accumx2+lines[values, 2]</span>
<span class="c"># #                accumy2 = accumy2+lines[values, 3]</span>
<span class="c"># #                accumAngle = accumAngle+(angle[values]%cv2.cv.CV_PI)</span>
<span class="c"># #            accumx1 = accumx1/valueNumber</span>
<span class="c"># #            accumy1 = accumy1/valueNumber</span>
<span class="c"># #            accumx2 = accumx2/valueNumber*100</span>
<span class="c"># #            accumy2 = accumy2/valueNumber*100</span>
<span class="c">#             accumAngleX = (accumAngleX/n + numpy.cos(self.angle))*100</span>
<span class="c">#             accumAngleY =  (accumAngleY/n + numpy.sin(self.angle))*100</span>
<span class="c"># #            accumAngle = (self.angle%cv2.cv.CV_PI + accumAngle/numpy.float(valueNumber))%cv2.cv.CV_PI</span>
<span class="c">#             </span>
<span class="c"># #            x1 = numpy.uint16(-numpy.cos(accumAngle)*1000.0)</span>
<span class="c"># #            y1 = numpy.uint16(-numpy.sin(accumAngle)*1000.0)</span>
<span class="c"># #            x2= numpy.uint16(+numpy.cos(accumAngle)*1000.0)</span>
<span class="c"># #            y2= numpy.uint16(+numpy.sin(accumAngle)*1000.0)</span>
<span class="c">#             cv2.line(img, (self.xoffset, self.yoffset), (self.xoffset+numpy.int(accumAngleX), self.yoffset+numpy.int(accumAngleY)), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)    </span>
<span class="c"># #            cv2.line(img, (self.xoffset+numpy.int(x1), self.yoffset+numpy.int(y1)), (self.xoffset+numpy.int(x2), self.yoffset+numpy.int(y2)), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c">#     #        cv2.line(img, (self.xoffset+numpy.int(numpy.median(lines[:, 0])), self.yoffset+numpy.int(numpy.median(lines[:, 1]))), (self.xoffset+numpy.int(numpy.median(lines[:, 2])), self.yoffset+numpy.int(numpy.median(lines[:, 3]))), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c">#             self.angle = numpy.arctan(numpy.float(accumAngleY)/numpy.float(accumAngleX))</span>
<span class="c">#         else:</span>
<span class="c"># #            leng = numpy.sqrt(numpy.power(lines[3]-lines[1], 2)+numpy.power(lines[2]-lines[0], 2))</span>
<span class="c">#             accumAngle = self.angle + numpy.arctan(numpy.float(lines[3]-lines[1])/numpy.float(lines[2]-lines[0]))</span>
<span class="c">#             x2= numpy.uint16(numpy.cos(accumAngle)*100.0)</span>
<span class="c">#             y2= numpy.uint16(numpy.sin(accumAngle)*100.0)</span>
<span class="c">#             cv2.line(img, (self.xoffset, self.yoffset), (self.xoffset+numpy.int(x2), self.yoffset+numpy.int(y2)), cv2.cv.Scalar(255, 0, 0), 2, cv2.CV_AA, 0)</span>
<span class="c">#         return img</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">MasterThesis 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Yves-Rémi Van Eycke.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>